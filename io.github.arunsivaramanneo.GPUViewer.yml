id: io.github.arunsivaramanneo.GPUViewer
runtime: org.gnome.Platform
sdk: org.gnome.Sdk
runtime-version: '43'
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=x11
  - --socket=wayland
command: gpu-viewer
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
modules:
  - name: gpu-viewer
    buildsystem: meson
    post-install:
      # latest desktop-file-utils release (0.26) doesn't support desktop file spec v1.5
      - desktop-file-edit --set-key=Version --set-value=1.4 /app/share/applications/${FLATPAK_ID}.desktop
      - python -m compileall /app/share/gpu-viewer/Files
    sources:
      - type: archive
        url: https://github.com/arunsivaramanneo/GPU-Viewer/archive/v2.29/GPU-Viewer-2.29.tar.gz
        sha256: e2035829606652c15a361cc01a2fb7fe4ba363b653a152120a7f3dc9d77edb26
        x-checker-data:
          is-main-source: true
          type: json
          url: https://api.github.com/repos/arunsivaramanneo/GPU-Viewer/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: '"https://github.com/arunsivaramanneo/GPU-Viewer/archive/v" +
            $version + "/GPU-Viewer-" + $version + ".tar.gz"'
      - type: patch
        path: gpuviewer-theme-path.patch

    modules:
      - name: vulkan-tools
        buildsystem: cmake-ninja
        config-opts:
          - -DGLSLANG_INSTALL_DIR=/app
          - -DVULKAN_HEADERS_INSTALL_DIR=/app
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: archive
            url: https://github.com/KhronosGroup/Vulkan-Tools/archive/v1.3.240/Vulkan-Tools-1.3.240.tar.gz
            sha256: cca1080198eacf0cd247c700f8c5f961456440909c692fd2160042e94ba35317
#           x-checker-data:
#             type: anitya
#             project-id: 242111
#             stable-only: true
#             url-template: https://github.com/KhronosGroup/Vulkan-Tools/archive/v$version/Vulkan-Tools-$version.tar.gz
        modules:
          - name: vulkan-headers
            buildsystem: cmake-ninja
            sources:
              - type: archive
                url: https://github.com/KhronosGroup/Vulkan-Headers/archive/v1.3.240/Vulkan-Headers-v1.3.240.tar.gz
                sha256: 98734513f4847254ef5bdd31a9c897f64938dac0733b9aea9e4b3fd339d82281
#               x-checker-data:
#                 type: anitya
#                 project-id: 88835
#                 stable-only: true
#                 url-template: https://github.com/KhronosGroup/Vulkan-Headers/archive/v$version/Vulkan-Headers-v$version.tar.gz

      - name: mesa-demos
        buildsystem: meson
        config-opts:
          - --bindir=/app/lib/mesa-demos
          - -Dosmesa=disabled
        post-install:
          - mv -v /app/lib/mesa-demos/*info /app/bin/
        sources:
          - type: archive
            url: https://mesa.freedesktop.org/archive/demos/8.5.0/mesa-demos-8.5.0.tar.gz
            sha256: 2472818cea452a34229d03084e7c81f94267d14a39c5287379de0fb1dc02caab
            x-checker-data:
              type: anitya
              project-id: 16781
              stable-only: true
              url-template: https://mesa.freedesktop.org/archive/demos/$version/mesa-demos-$version.tar.gz
        cleanup:
          - /lib/mesa-demos
        modules:
          - shared-modules/glew/glew.json
          - shared-modules/glu/glu-9.json

          - name: freeglut
            buildsystem: cmake-ninja
            build-options:
              cflags: -fcommon
            config-opts:
              - -DCMAKE_BUILD_TYPE=None
              - -DFREEGLUT_BUILD_STATIC_LIBS=OFF
              - -DOpenGL_GL_PREFERENCE=LEGACY
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/freeglut/freeglut-3.4.0.tar.gz
                sha256: 3c0bcb915d9b180a97edaebd011b7a1de54583a838644dcd42bb0ea0c6f3eaec
                x-checker-data:
                  type: anitya
                  project-id: 846
                  stable-only: true
                  url-template: https://downloads.sourceforge.net/freeglut/freeglut-$version.tar.gz

      - name: clinfo
        no-autogen: true
        no-make-install: true
        build-commands:
          - install -Dm755 -t /app/bin/ clinfo
        sources:
          - type: archive
            url: https://github.com/Oblomov/clinfo/archive/3.0.23.01.25/clinfo-3.0.23.01.25.tar.gz
            sha256: 6dcdada6c115873db78c7ffc62b9fc1ee7a2d08854a3bccea396df312e7331e3
            x-checker-data:
              type: anitya
              project-id: 10503
              stable-only: true
              url-template: https://github.com/Oblomov/clinfo/archive/$version/clinfo-$version.tar.gz
        modules:
          - name: opencl-headers
            buildsystem: cmake
            config-opts:
              - -DCMAKE_INSTALL_DATADIR=/app/lib
            sources:
              - type: archive
                url: https://github.com/KhronosGroup/OpenCL-Headers/archive/v2023.04.17/OpenCL-Headers-v2023.04.17.tar.gz
                sha256: 0ce992f4167f958f68a37918dec6325be18f848dee29a4521c633aae3304915d
                x-checker-data:
                  type: anitya
                  project-id: 223257
                  stable-only: true
                  url-template: https://github.com/KhronosGroup/OpenCL-Headers/archive/v$version/OpenCL-Headers-v$version.tar.gz

      - name: pygobject
        buildsystem: meson
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/pygobject/-/archive/3.44.1/pygobject-3.44.1.tar.gz
            sha256: f2c3f85161c32791a60c2f2b54fdb89e38f1acde0f6a8f0be4e0e36f73f144ad
            x-checker-data:
              type: anitya
              project-id: 13158
              stable-only: true
              url-template: https://gitlab.gnome.org/GNOME/pygobject/-/archive/$version/pygobject-$version.tar.gz
        modules:
          - name: pycairo
            buildsystem: meson
            sources:
              - type: archive
                url: https://github.com/pygobject/pycairo/archive/v1.24.0/pycairo-v1.24.0.tar.gz
                sha256: 94f4e743853ac02b0671a65fec1d0e3c31fd7f13256498303d9530c69a2d9903
                x-checker-data:
                  type: anitya
                  project-id: 13166
                  stable-only: true
                  url-template: https://github.com/pygobject/pycairo/archive/v$version/pycairo-v$version.tar.gz

      - name: python-click
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "click" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/59/87/84326af34517fca8c58418d148f2403df25303e02736832403587318e9e8/click-8.1.3.tar.gz
            sha256: 7682dc8afb30297001674575ea00d1814d808d6a36af415a82bd481d37ba7b8e
            x-checker-data:
              type: pypi
              name: click

      - name: vdpauinfo
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/vdpau/vdpauinfo/-/archive/1.5/vdpauinfo-1.5.tar.gz
            sha256: 1878d54f6732d02cedef8eabe77e23fc2239b4ec202612403a383f4140a17bc3
            x-checker-data:
              type: anitya
              project-id: 16031
              stable-only: true
              url-template: https://gitlab.freedesktop.org/vdpau/vdpauinfo/-/archive/$version/vdpauinfo-$version.tar.gz

      - name: gtk-orchis-theme
        buildsystem: simple
        build-commands:
          - ./install.sh -d ${FLATPAK_DEST}/share/themes -t default -s standard
        sources:
          - type: archive
            url: https://github.com/vinceliuice/orchis-theme/archive/2023-05-27/orchis-theme-2023-05-27.tar.gz
            sha256: 4e7b9511a6d816f65356e2f2493ef9764471662213cf80e7d9003420be9ed935
            x-checker-data:
              type: json
              url: https://api.github.com/repos/vinceliuice/orchis-theme/releases/latest
              version-query: .tag_name
              url-query: '"https://github.com/vinceliuice/orchis-theme/archive/" +
                $version + "/orchis-theme-" + $version + ".tar.gz"'
        cleanup:
          - /share/themes/*/cinnamon
          - /share/themes/*/gnome-shell
          - /share/themes/*/gtk-2.0
          - /share/themes/*/gtk-3.0
          - /share/themes/*/metacity-1
          - /share/themes/*/plank
          - /share/themes/*/xfwm4
          - /share/themes/*/COPYING
        modules:
          - name: sassc
            sources:
              - type: archive
                url: https://github.com/sass/sassc/archive/3.6.2/sassc-3.6.2.tar.gz
                sha256: 608dc9002b45a91d11ed59e352469ecc05e4f58fc1259fc9a9f5b8f0f8348a03
                x-checker-data:
                  type: anitya
                  project-id: 12485
                  stable-only: true
                  url-template: https://github.com/sass/sassc/archive/$version/sassc-$version.tar.gz
              - type: shell
                commands:
                  - autoreconf -fiv
            cleanup:
              - '*'
            modules:
              - name: libsass
                config-opts:
                  - --enable-shared
                  - --disable-static
                sources:
                  - type: archive
                    url: https://github.com/sass/libsass/archive/3.6.5/libsass-3.6.5.tar.gz
                    sha256: 89d8f2c46ae2b1b826b58ce7dde966a176bac41975b82e84ad46b01a55080582
                    x-checker-data:
                      type: anitya
                      project-id: 11766
                      stable-only: true
                      url-template: https://github.com/sass/libsass/archive/$version/libsass-$version.tar.gz
                  - type: shell
                    commands:
                      - autoreconf -fiv
                cleanup:
                  - '*'

      - name: lsb-release-compat
        buildsystem: simple
        build-commands:
          - make install PREFIX=/app
        sources:
          - type: git
            url: https://gitlab.com/nanonyme/lsb-release-compat.git
            branch: master
            commit: f4f908b62dcc9cd081eb2a42b6ad7cf98db4bb10
